---
- name: ubuntu
  when: ansible_distribution == "Ubuntu" and ansible_distribution_major_version|int >= 20
  block:
  - name: add docker repo key
    ansible.builtin.get_url:
      url: "https://download.docker.com/linux/ubuntu/gpg"
      dest: /etc/apt/trusted.gpg.d/docker.asc
      mode: '0644'
      force: true
  - name: add docker repo
    ansible.builtin.apt_repository:
      filename: dockerrepo
      repo: "deb [arch=amd64 signed-by=/etc/apt/trusted.gpg.d/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
- name: debian
  when: ansible_distribution == "Debian" and ansible_distribution_major_version|int >= 11
  block:
  - name: add docker repo key
    ansible.builtin.get_url:
      url: "https://download.docker.com/linux/debian/gpg"
      dest: /etc/apt/trusted.gpg.d/docker.asc
      mode: '0644'
      force: true
  - name: add docker repo
    ansible.builtin.apt_repository:
      filename: dockerrepo
      repo: "deb [arch=amd64 signed-by=/etc/apt/trusted.gpg.d/docker.asc] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
- name: install docker-ce
  ansible.builtin.apt:
    name: docker-ce
    state: present
    update_cache: yes
- ansible.builtin.group:
    name: docker 
    state: present
- name: ubuntu user
  ansible.builtin.user:
    name: ubuntu
    append: yes
    groups: docker
  when: ansible_distribution == "Ubuntu" and ansible_distribution_major_version|int >= 20
- name: debian user
  ansible.builtin.user:
    name: admin
    append: yes
    groups: docker
  when: ansible_distribution == "Debian" and ansible_distribution_major_version|int >= 11
- name: ensure base services are started
  ansible.builtin.service:
    name: docker
    state: started
    enabled: yes