[Unit]
Description=Caddy HTTP/2 web server
After=network-online.target
Wants=network-online.target systemd-networkd-wait-online.service

[Service]
WorkingDirectory={{ caddy_install_dir }}
Environment=CADDYPATH={{ caddy_data_dir }}

User=caddy
Group=caddy

Restart=on-abnormal
RestartSec=5
KillMode=mixed
KillSignal=SIGQUIT
TimeoutStopSec=5s

PrivateTmp=true
PrivateDevice=false
ProtectHome=true
ProtectSystem=full
ReadWriteDirectories={{ caddy_data_dir }}

ExecStart={{ caddy_install_dir }}/caddy -conf {{ caddy_config_dir }}/Caddyfile -log stderr -agree -root=/var/tmp
ExecStop=-/usr/bin/pkill --pidfile /var/run/caddy.pid

PIDFile=/var/run/caddy.pid

LimitNOFILE=1048576
LimitNPROC=512

{% if use_systemd_capabilities %} 
; The following additional security directives only work with systemd v229 or later.
; They further restrict privileges that can be gained by caddy. Uncomment if you like.
; Note that you may have to add capabilities required by any plugins in use.
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_BIND_SERVICE
NoNewPrivileges=true
{% endif %}

[Install]
WantedBy=multi-user.target
